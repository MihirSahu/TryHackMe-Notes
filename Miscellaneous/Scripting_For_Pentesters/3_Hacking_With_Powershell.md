# Hacking With Powershell


## What is Powershell?
```
Powershell is the Windows Scripting Language and shell environment that is built using the .NET framework.

This also allows Powershell to execute .NET functions directly from its shell. Most Powershell commands, called cmdlets, are written in .NET. Unlike other scripting languages and shell environments, the output of these cmdlets are objects - making Powershell somewhat object oriented. This also means that running cmdlets allows you to perform actions on the output object(which makes it convenient to pass output from one cmdlet to another). The normal format of a cmdlet is represented using Verb-Noun; for example the cmdlet to list commands is called Get-Command.
```
- [List of approved verbs](https://docs.microsoft.com/en-us/powershell/scripting/developer/cmdlet/approved-verbs-for-windows-powershell-commands?view=powershell-7)

## Basic Powershell Commands
- `get-help <command name>`
    - Use -examples flag to get examples
- `get-command`
    - Get all cmdlets on computer, can search using wildcards
- Object manipulation
```
The Pipeline(|) is used to pass output from one cmdlet to another. A major difference compared to other shells is that instead of passing text or string to the command after the pipe, powershell passes an object to the next cmdlet. Like every object in object oriented frameworks, an object will contain methods and properties. You can think of methods as functions that can be applied to output from the cmdlet and you can think of properties as variables in the output from a cmdlet. To view these details, pass the output of a cmdlet to the Get-Member cmdlet
```
    - Ex.
        -`Get-Command | Get-Member -MemberType Method`
- `get-member`
    - Find all properties and methods of an object
- `select-object`
    - Create objects from the output of other cmdlets
    - `Get-ChildItem | Select-Object -Property Name, Mode`
- `where-object`
    - Filter based on the value of properties
    - Basic format is `Verb-Noun | Where-Object -Property PropertyName -operator Value` or `Verb-Noun | Where-Object {$_.PropertyName -operator Value}`
    - [List of operators](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/where-object?view=powershell-6)
    - Ex.
        - `get-service | where-object -Property Status -EQ Running`
- `sort-object`
    - Sort information in an object

- Exercises
    1. Use `get-childitem -path C:\ -recurse | Where-Object -property name -EQ "interesting-file.txt.txt"` to get `C:\Program Files`
    2. Use `get-content .\interesting-file.txt.txt` to get `notsointerestingcontent`
    3. Use `get-command | where-object -Property CommandType -EQ Cmdlet | Measure-Object` to get `6638`
    4. Use `Get-FileHash -Algorithm MD5 .\interesting-file.txt.txt | select-object -Property Hash` to get `49A586A2A9456226F8A1B4CEC6FAB329`
    5. `get-location`
    6. Use `cd C:\Users\Administrator\Documents\Passwords` and find that it doesn't exist
    7. `invoke-webrequest`
    8. `ihopeyoudidthisonwindows`

## Enumeration
- Exercises
    1. `get-localuser` to get 5 users
    2. Use `Get-LocalUser -SID S-1-5-21-1394777289-3961777894-1791813945-501` to get `Guest`
    3. Use `Get-LocalUser | Where-Object -Property PasswordRequired -Match false` to get 4
    4. Use `get-localgroup | Measure-Object` to get 24
    5. Use `get-netipaddress`
    6. Use `Get-NetTCPConnection | Where-Object -Property State -eq Listen | Measure-Object` to get 20
    7. Use `Get-NetTCPConnection | Where-Object -Property State -eq Listen | Where-Object -Property LocalPort -eq 445` to get `::`
    8. Use `get-hotfix | Measure-Object` to get 20
    9. Use `Get-HotFix -Id KB4023834 | Select-Object -Property InstalledOn` to get `6/15/2017 12:00:00 AM`
    10. Use `Get-ChildItem -Path C:\ -Include *.bak* -File -Recurse -ErrorAction SilentlyContinue` and `Get-Content "C:\Program Files (x86)\Internet Explorer\passwords.bak.txt"` to get `backpassflag`
    11. Use `Get-ChildItem C:\* -Recurse | Select-String -pattern API_KEY` to get `fakekey123`
    12. `Get-Process`
    13. Use `Get-ScheduledTask -TaskName new-sched-task` to get `\`
    14. Use `Get-Acl` to get `NT SERVICE\TrustedInstaller`

## Basic Scripting
```
$system_ports = Get-NetTCPConnection -State Listen

$text_port = Get-Content -Path C:\Users\Administrator\Desktop\ports.txt

foreach($port in $text_port){

    if($port -in $system_ports.LocalPort){
        echo $port
     }

}
```

- Exercises

```
$folders = Get-ChildItem -Path "C:\Users\Administrator\Desktop\emails"
$path = "C:\Users\Administrator\Desktop\emails"

foreach ($folder in $folders) {
    Get-ChildItem -Path ($path + '\' + $folder) | Select-String -Pattern password
}

Start-Sleep -Seconds 10
```
    1. `Doc3M`
    2. `johnisalegend99`
    3. In the script I wrote change the string `password` to `https` and find that the link is in `Doc2Mary`

## Intermediate Scripting
```
$ip = Read-Host "Which IP address do you want to scan?"
$ports = Read-Host "Which ports do you want to scan? Ex. 2..5" | Invoke-Expression

foreach ($port in $ports) {
    Test-NetConnection -ComputerName $ip -Port $port
}
```
